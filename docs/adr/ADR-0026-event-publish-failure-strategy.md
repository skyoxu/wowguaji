# ADR-0026: 事件发布失败策略（PublishAsync Failure Semantics）

- Status: Accepted
- Context: 事件驱动的玩法与 UI/AI 会复用同一条发布链路；如果不定义“发布失败”的语义与边界，容易出现状态半提交、异常被吞、或 failure 被误当作业务成功的情况，导致验收与回归不稳定。
- Decision:
  - 订阅者异常隔离：`IEventBus.PublishAsync(...)` 必须捕获并隔离单个订阅者/处理器抛出的异常；不得因为某一个订阅者失败而让整次发布对调用方表现为失败。
  - 发布自身失败可见：当事件总线自身出现不可恢复错误（例如内部状态损坏、序列化不可恢复失败、关键依赖不可用）时，允许 `PublishAsync` 抛出异常；该异常必须携带上下文（事件类型、调用点、失败原因）并被上层处理为“本次操作失败”。
  - 状态一致性优先：对“会改变领域状态且需要发布事件”的操作（例如购买、支付、结算），服务层必须保证发布失败不会导致领域状态处于半提交状态；推荐采用“先计算 -> 再提交”的事务式编排（必要时回滚/拒绝提交）。
  - 审计与可观测：发布失败与订阅者异常都必须记录（结构化日志/审计），用于 acceptance_check 的确定性证据与排障回溯。
- Consequences:
  - 正向：避免某个 handler 抛异常导致整条事件链崩溃；避免 fire-and-forget 丢失故障；提高单机玩法闭环的确定性与可回归性。
  - 代价：需要在事件总线实现中增加异常隔离、上下文包装与审计落盘；对服务层的“事务式编排”提出约束。
- References:
  - ADR-0004: 事件总线与契约
  - ADR-0003: 可观测性与 Release Health
  - ADR-0019: Godot 安全基线（审计与落盘）
  - ADR-0025: Godot 测试策略（TDD + GdUnit4）
