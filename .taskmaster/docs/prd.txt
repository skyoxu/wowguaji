一，T2阶段「最小可玩闭环」PRD文档（类 Melvor Idle 放置RPG，含地图DLC）\n二，系统范围与目标\n\n2.1 本项目是一款基于 Godot 4.x（Mono/.NET）、使用 C# 开发的单机离线放置类RPG。核心玩法参考《Melvor Idle》：多技能放置产出 + 轻策略自动战斗 + 制作/掉落驱动成长 + 地图区域推进（解锁）为主。\n\n2.2 范围：T2阶段聚焦“最小可玩闭环（MVP Loop）”，实现从新档开始到“解锁区域/击败阶段Boss/完成关键任务结算”的可重复循环流程；同时包含“地图DLC”的最小可用接入、可见、可进入、可联动验证。\n\n2.3 不在T2必做范围（但需预留结构）：多人联机、排行榜、复杂剧情长链、拍卖行/玩家交易、深度Build系统（大量天赋树/技能循环）、多角色队伍系统、复杂经济模拟等。\n\n2.4 目标：实现完整玩法闭环：\n开始新档 → 选择活动（采集/制作/战斗）→ 资源/经验增长 → 制作与装备提升 → 解锁新区域与更高阶内容 → 阶段Boss/关键任务完成 → 结算与持续成长 → 可继续推进或重开新档。\n\n2.5 BMAD（用于对齐设计意图）：\n\nB（Behavior 行为）：选技能活动挂机—收资源—制作/装备—刷怪掉落—解锁区域—继续挂机；\n\nM（Motivation 动机）：追求更高效率与更强战斗力，解锁更广地图与更稀有掉落；\n\nA（Aesthetics 审美）：数值与成长可读、产出反馈清晰、稀有掉落“有仪式感”、界面像“仪表盘”；\n\nD（Dynamics 动态）：多技能协同（资源链路）、风险/收益权衡（战斗区域）、长期目标（成就/收集/地图解锁）、离线收益节奏控制（上限与倍率可配）。\n\n2.6 仓库约束说明：你提到需要“针对你的 github 的 godotgame 仓库结构”，但当前对话中未提供仓库URL/用户名，且没有可直接访问的连接源；本PRD将以“标准 Godot4+C# 分层工程”作为默认结构约束（见第5章），后续你给出仓库链接后可再做“对齐现有目录/命名/Autoload 入口”的落地映射。\n\n三，用户故事\n\n3.1 放置采集：作为玩家，我希望选择一个采集技能与资源点开始挂机，以持续获得资源与技能经验。\n\n3.2 技能成长：作为玩家，我希望技能升级能解锁更高级资源/配方/区域条件，从而形成“越练越强”的正反馈。\n\n3.3 制作提升：作为玩家，我希望能把采集资源转化为装备/消耗品，提高战斗与效率。\n\n3.4 战斗刷装：作为玩家，我希望选择怪物/区域开始自动战斗，获得金币与掉落，逐步挑战更强敌人。\n\n3.5 地图推进：作为玩家，我希望通过战斗、技能等级或任务条件解锁新区域，使玩法从“点状活动”扩展为“世界推进”。\n\n3.6 离线收益：作为玩家，我希望离线期间能获得合理的采集/制作收益，上线时一次性结算，保持放置体验。\n\n3.7 DLC联动：作为玩家，我希望地图DLC的新区域能与主世界互相反哺（资源、配方、增益、任务），而不是完全割裂。\n\n四，功能模块（T2最小闭环 + 可扩展预留）\n4.1 资源采集与产出（Gathering）\n\n4.1.1 采集技能（T2最小集建议）：采矿/伐木/钓鱼/农耕（可先落地2–3个，结构支持继续加）。\n4.1.2 资源点数据：每个资源点包含：\na.ID；b.名称；c.所需技能与等级；d.产出物（主产物/副产物）；e.基础周期（秒）；f.每周期产量；g.稀有掉落表（可选）。\n4.1.3 采集循环：开始采集 → 按周期产出资源与经验 → 玩家可随时停止/切换。\n4.1.4 稀有产出（建议做“结构+少量内容”）：小概率掉落稀有材料/宝箱，触发UI高亮提示。\n4.1.5 扩展预留：精力/疲劳、工具品质、区域限定资源、稀有矿脉/鱼群刷新（WoW式“稀有刷新”但保持轻量）。\n\n4.2 技能成长与全局加成（Skills）\n\n4.2.1 技能结构：每个技能独立EXP与等级；等级提升解锁资源点/配方/区域条件。\n4.2.2 里程碑：关键等级（10/20/…/Max）触发解锁与提示。\n4.2.3 技能协同：采集→制作→战斗的资源链路；部分技能提供全局被动（如采集速度、掉落率、制作速度微增）。\n4.2.4 可选参考（WoW元素，轻量植入）：专精/天赋（高等级后选择方向，仅提供被动加成，不引入复杂战斗循环）。\n4.2.5 扩展预留：技能上限提升、技能试炼、技能专属装备、局外永久加成（若未来引入）。\n\n4.3 制作与配方（Crafting）\n\n4.3.1 制作技能（T2最小集建议）：锻造/烹饪（可先落地1个，结构支持扩展）。\n4.3.2 配方数据：每个配方包含：材料需求、产物、制作周期、给予经验、解锁条件。\n4.3.3 制作循环：选择配方 → 检查材料 → 扣材料 → 计时完成 → 入库产物 + 经验。\n4.3.4 扩展预留：批量制作、制作暴击、附魔/强化、配方书掉落（WoW式“配方获取”）。\n\n4.4 战斗系统（Combat）\n\n4.4.1 战斗形态：选择怪物/区域 → 自动战斗Tick（按攻击间隔结算）→ 胜利掉落/失败结算。\n4.4.2 参与者：玩家（装备/属性/状态） + 敌人（属性/掉落表/技能循环可选）。\n4.4.3 伤害与生存：HP、攻击、命中/闪避（可选）、防御/减伤；护盾/格挡（可选）。\n4.4.4 状态系统（T2最小集，规则固定便于实现）：\na.力量：伤害 +X；\nb.虚弱：造成伤害 -Y；\nc.易伤：受到伤害 +P%；\nd.中毒：每Tick扣血并衰减（或固定时长）。\n4.4.5 掉落：金币 + 道具（装备/材料/消耗品），按掉落表权重随机。\n4.4.6 胜负判定：敌人HP≤0胜利；玩家HP≤0失败；失败惩罚T2建议轻量（丢失当次战利品/战斗中断）。\n4.4.7 轻策略（不改变放置大框架，T2可只做“入口结构”）：\na.攻击样式（稳/快/重击）；b.克制（敌人对某类伤害更弱）；c.Boss技能循环（后续扩展）。\n4.4.8 离线战斗规则（明确约束）：T2默认不模拟离线战斗；若要离线战斗，建议以后用“派遣/随从”机制替代（见4.11.4），避免离线死亡/负反馈难以解释。\n\n4.5 物品、装备与背包（Items & Inventory）\n\n4.5.1 物品类型：资源、装备、消耗品、任务物品、货币。\n4.5.2 背包/银行：全局仓库（可无限或容量上限）；支持堆叠、分类、搜索；装备栏位（武器/防具/饰品…）。\n4.5.3 装备属性：基础属性（攻击、防御、HP等）+ 可选词缀；穿戴后影响战斗/效率。\n4.5.4 消耗品：食物/药水（战斗回复/增益），预留携带上限与冷却字段。\n4.5.5 扩展预留：耐久、套装效果、收藏图鉴、商店NPC与经济平衡。\n\n4.6 任务与成就（Quests & Achievements）\n\n4.6.1 新手引导任务：引导完成“采集→制作→战斗→解锁区域”的闭环。\n4.6.2 任务链（参考WoW但轻量）：区域任务链推动地图解锁；任务奖励关键配方/解锁道具/永久被动。\n4.6.3 成就：技能里程碑、Boss击杀、收集套装、区域全解锁等；奖励以展示/轻量加成为主。\n4.6.4 扩展预留：日常/周常、声望体系（折扣/配方/被动）、隐藏成就。\n\n4.7 地图与区域（World Map）\n\n4.7.1 地图形态：世界由多个“区域（Region）”组成；区域挂载：\na.采集点列表；b.战斗怪物池/地下城；c.商店/事件（可选）。\n4.7.2 解锁规则：技能等级门槛、任务链、击败区域Boss或关键道具解锁。\n4.7.3 地图UI：显示已解锁/未解锁/可解锁条件提示；点击进入区域详情页。\n4.7.4 扩展预留：区域事件、天气/生态加成、稀有怪/稀有资源、随机遭遇。\n\n4.8 地图DLC（联动拓展机制）\n\n4.8.1 DLC定位：新增若干区域（地图扩展包），与主世界形成资源/配方/奖励联动。\n4.8.2 DLC内容最小集（T2必须可验证）：\na.新区域（含采集点与敌人）；b.新资源材料；c.新配方或装备线；d.新任务链入口（与主世界衔接）。\n4.8.3 与主世界联动（必须）：\na.资源反哺：DLC材料可用于主世界锻造/强化；\nb.能力反哺：DLC里程碑给予全局被动（掉落率/制作速度/HP上限等）；\nc.任务衔接：主世界任务链提供“进入DLC”的引导与条件。\n4.8.4 数据兼容：DLC内容独立ID命名空间（如 DLC1_*）；存档记录 EnabledDLCs 与 DLC解锁状态；未启用DLC时相关内容不生效但数据保留。\n4.8.5 扩展预留：多DLC并存、DLC之间联动成就/隐藏任务、DLC专属Boss词缀。\n\n4.9 UI/UX（仪表盘式放置体验）\n\n4.9.1 主界面：技能总览（等级/进度）、当前活动（产出速率/剩余时间/当前目标）、快捷切换。\n4.9.2 分页：采集页、制作页、战斗页、背包页、任务页、地图页、设置页。\n4.9.3 反馈：升级提示、稀有掉落高亮提示、战斗掉落结算面板、离线收益结算面板。\n4.9.4 扩展预留：内置百科/掉落查询、筛选排序、可访问性设置、快捷键与手柄映射。\n\n4.10 存档与离线收益（Save/Offline）\n\n4.10.1 存档：自动存档 + 手动存档；保存技能/背包/任务/地图解锁/DLC状态等。\n4.10.2 版本与迁移：存档携带 Version；新增技能/物品/DLC时走默认值补齐与迁移。\n4.10.3 离线结算：记录 lastOnlineTime；上线按离线时长结算采集/制作收益（建议设离线收益上限8–12小时；参数可配置）。\n4.10.4 扩展预留：云存档（Steam/自建）、反作弊校验、多存档位。\n\n4.11 可选参考（WoW元素“轻量植入”，不改变放置大框架）\n\n4.11.1 专业协同：采集专业互供材料，制作专业提供强化/消耗品。\n4.11.2 稀有刷新：区域内定时/概率出现“稀有资源点/稀有精英”，掉落独特材料。\n4.11.3 任务链与声望：任务链解锁区域；声望等级提供折扣/配方/被动。\n4.11.4 宠物/随从（扩展）：作为纯被动增益（产出+%、掉落+%），并可作为“离线派遣”载体（替代离线战斗模拟）。\n\n4.12 时间推进与节拍规则详述（放置循环的“时间”）\n\n4.12.1 在线：以“Tick”为最小单位（建议1s或更细），由 TimeService 统一驱动各活动结算。\n4.12.2 活动节拍：\na.采集：每周期产出一次（周期可为2s/5s等）；\nb.制作：按配方制作周期完成；\nc.战斗：按攻击间隔结算伤害、状态与死亡判定。\n4.12.3 离线：仅对“可离线活动”结算（T2默认采集/制作）；战斗不离线结算。\n4.12.4 离线收益上限：按配置 capHours 截断；超出部分不计算或按衰减倍率计算（T2建议先做“硬上限”）。\n\n五，系统架构设计（ARC42/C4）\n5.1 系统上下文\n\n5.1.1 本游戏为离线单机系统，运行于本地 Godot 客户端进程内。外部交互边界主要为：\na.输入：键鼠/手柄 → UI 操作（选活动、制作、开战、地图解锁查看）；\nb.输出：渲染/音频/动画 → 玩家反馈；\nc.存储：本地文件系统 user://（存档、日志、可选配置覆盖）；\nd.网络：T2默认无服务器依赖（云存档/Steam成就为可选适配容器）。\n\n5.2 模块分层（C4容器视图）\n\n5.2.1 建议采用“核心逻辑与引擎解耦”的分层结构（端口-适配器思想）：\n5.2.2 游戏核心逻辑 (Game.Core)：纯 C# 领域层，包含规则与数据模型：技能、活动Tick、战斗结算、掉落、制作、地图解锁、任务与成就、GameState。Core 不直接依赖 Godot API，便于单测与未来扩展。\n5.2.3 Godot 表现层 (Game.Godot)：场景树、UI、输入、动画与音效。该层通过调用 Core 的用例接口驱动逻辑，并订阅 Core 的领域事件刷新表现。\n5.2.4 事件与系统服务（Autoload）：EventBus、RngService、TimeService（离线差值/活动Tick）、DataStore、Logger、ConfigService、AudioService。\n5.2.5 存储容器：本地文件系统（JSON或二进制）。Core 定义 GameState/DTO；Godot 层通过 IDataStore 写入/读取，并处理版本迁移入口。\n\n5.3 主要组件与类设计（C4组件视图：含“内部关键子组件职责”）\n\n5.3.1 Game.Core（领域模型 / 用例）\na. GameState：存档快照（技能/背包/地图解锁/任务进度/DLC标记/版本号/lastOnlineTime）。\nb. SkillManager：技能注册、经验/等级提升、解锁触发。\nc. ActivitySystem：统一管理当前活动（采集/制作/战斗）的开始/停止与Tick结算；可同时支持“主活动 + 后台活动”（未来扩展）。\nd. GatheringModel + ResourceManager：采集点数据、产出周期、稀有表与条件校验。\ne. CraftingManager：配方读取、材料校验、扣减、产物生成、经验结算。\nf. CombatManager：战斗状态、攻击间隔Tick、状态结算、胜负判定。\ng. DamageCalculator（战斗子组件）：纯函数/服务，负责计算最终伤害（便于测试与平衡）。\nh. LootGenerator（战斗子组件）：按掉落表权重roll，输出掉落列表（可固定seed复现）。\ni. InventoryManager：背包/银行、堆叠、装备穿戴与属性汇总（含“角色最终属性聚合”）。\nj. QuestManager：任务状态机（未接/进行/完成/领奖），订阅领域事件推进目标。\nk. AchievementTracker：成就检测与标记，订阅领域事件。\nl. MapManager：区域列表、解锁条件判断、区域内容挂载（采集点/怪物池/事件）。\nm. DlcManager：DLC启用、内容注册、联动规则挂钩（资源/配方/全局被动）。\n\n5.3.2 Game.Godot（场景与UI）\na. MainScene：新档/继续、设置；\nb. SkillScreen：技能总览与进入活动；\nc. GatheringScreen / CraftingScreen：采集/制作操作与产出展示；\nd. CombatScreen：战斗展示（HP、状态、掉落结算、开始/停止）；\ne. InventoryScreen：背包/装备管理；\nf. QuestScreen：任务与成就；\ng. MapScreen：世界地图与区域解锁展示（含DLC区域锁定提示）；\nh. OfflineRewardDialog：离线收益结算展示。\n\n5.4 节点脚本与信号（交互约束）\n\n5.4.1 UI脚本只负责收集输入并触发用例（StartActivity/StopActivity/Craft/StartCombat/EnterRegion）；Core 通过 EventBus 发布领域事件（ItemAdded、SkillLeveledUp、RegionUnlocked、CombatEnded、OfflineRewardGranted）。\n5.4.2 逻辑先行：Core先结算并发事件；表现层可延迟播放动画/提示，但不回写逻辑。\n5.4.3 时间驱动统一化：TimeService → 调用 ActivitySystem.Tick(delta) → 由活动内部自行判断“是否到周期”。\n\n5.5 数据驱动与DLC接入规范（关键约束）\n\n5.5.1 静态配置（Content，JSON或Godot Resource）：Skills、Nodes(采集点)、Recipes、Items、Enemies、Regions、Quests、Achievements、DLCManifest。\n5.5.2 ID规范：主游戏与DLC分命名空间（Base_* / DLC1_*），避免冲突；引用用ID而非数组下标。\n5.5.3 存档兼容：GameState包含 Version + EnabledDLCs + RegionUnlocks；加载时根据版本迁移补字段。\n5.5.4 内容热插拔（预留）：若未来采用pck资源包加载DLC，则 DlcManager 负责“加载 → 合并配置 → 注册”。\n\n六，运行场景与运行时序（补齐长版的两条链路）\n6.1 典型运行场景（启动→游玩→离线→回归）\n\n6.1.1 启动：进入MainScene → 读取存档列表 → 选择继续或新档。\n6.1.2 加载：DataStore.Load(GameState) → Core恢复状态（技能/背包/地图/DLC）。\n6.1.3 离线结算：若存在 lastOnlineTime → OfflineCalculator 计算收益 → 发出 OfflineRewardGranted → UI弹窗展示。\n6.1.4 日常游玩：玩家在技能总览选择采集/制作或进入战斗；系统持续Tick并产出/成长。\n6.1.5 切换活动：玩家停止当前活动并切换到其他活动，或进入地图解锁/任务领奖。\n6.1.6 退出：自动存档或手动存档，写入 lastOnlineTime = now。\n\n6.2 运行时序示例1：一次采集的全链路（UI→产出→背包→任务→UI）\n\n6.2.1 玩家在 SkillScreen 选择“采矿”，在 GatheringScreen 选择矿点并点击“开始”。\n6.2.2 UI调用 Core：ActivitySystem.StartGathering(nodeId)。\n6.2.3 Gathering活动校验：ResourceManager 校验等级/解锁/容量策略（T2可不做容量）。\n6.2.4 TimeService 每Tick驱动：ActivitySystem.Tick → GatheringAction 计时达到周期 → 产出资源与经验。\n6.2.5 InventoryManager.AddItem(itemId,count)；SkillManager.GainExp(skill,exp)。\n6.2.6 Core发布事件：ItemAdded、SkillExpChanged；若升级则 SkillLeveledUp。\n6.2.7 QuestManager/AchievementTracker 订阅事件：更新“采集X次/采集Y材料/技能到达LvN”等目标。\n6.2.8 UI订阅事件：\na.背包数量刷新；b.技能等级/进度刷新；c.稀有掉落弹提示。\n6.2.9 玩家点击“停止”或切换技能 → ActivitySystem.StopCurrent() → 保存活动状态（T2可只保存“当前活动ID”）。\n\n6.3 运行时序示例2：一次战斗的全链路（开战→伤害→掉落→解锁→结算）\n\n6.3.1 玩家在 CombatScreen 选择敌人/区域并点击“开始战斗”。\n6.3.2 UI调用 Core：CombatManager.StartBattle(enemyId, regionId)。\n6.3.3 初始化：根据装备与角色属性计算战斗面板初始值（HP/攻击/防御/状态）。\n6.3.4 Tick循环：按攻击间隔结算：\na. DamageCalculator 计算玩家对敌伤害；敌HP减少；\nb. 敌方对玩家造成伤害；玩家HP减少；\nc. 状态（中毒/虚弱等）按规则结算与衰减。\n6.3.5 胜负判定：\na.敌HP≤0：胜利 → LootGenerator roll掉落 → InventoryManager入库 → CombatEnded(win,drops)。\nb.玩家HP≤0：失败 → CombatEnded(fail)。\n6.3.6 Quest/Map联动：若击杀为Boss或满足条件 → QuestManager 标记完成 → MapManager.RegionUnlocked(regionId) → RegionUnlocked事件。\n6.3.7 UI结算：展示掉落列表、升级提示、区域解锁提示；回到地图或战斗列表。\n\n七，地图DLC实例（补齐长版的“具体案例”）\n7.1 DLC示例：DLC1「北境雪原」（可替换为你的真实DLC主题）\n\n7.1.1 新区域：North_Snowfield（雪原），包含：\na.采集点：寒冰矿脉、雪松林；\nb.怪物池：雪狼、冰元素；\nc.Boss：冰龙。\n7.1.2 新材料：DLC1_IceCrystal、DLC1_FrostHide。\n7.1.3 新配方联动（资源反哺）：\na.Base锻造配方新增“冰霜武器强化”需要 DLC1_IceCrystal；\nb.Base烹饪配方新增“抗寒炖汤”需要 DLC1_FrostHide（提供战斗抗性或HP上限微增）。\n7.1.4 新任务链入口（主世界衔接）：主世界高等级区域完成任务获得“雪原地图（DLC1_MapToken）”，若启用DLC则解锁进入雪原；未启用DLC则地图仅作为收藏/提示。\n7.1.5 能力反哺：击败冰龙后授予全局被动“寒霜祝福”：采集速度+X% 或 掉落率+Y%（参数可配）。\n7.1.6 表现联动（可选装饰）：主城出现“冰龙雕像”或成就徽章展示位，不影响数值，仅增强仪式感。\n\n八，测试与CI策略（补齐长版：粒度与组织方式）\n8.1 单元测试（Core纯逻辑）\n\n8.1.1 经验与等级：经验阈值、升级触发、解锁条件判断。\n8.1.2 掉落roll：固定seed下掉落可复现；权重边界（0权重/极端权重）。\n8.1.3 制作扣料：材料不足拒绝；材料足够扣减正确；产物入库正确。\n8.1.4 战斗胜负：给定属性时在固定Tick内胜负可预测；状态伤害/衰减符合规则。\n\n8.2 集成测试（Core+少量适配）\n\n8.2.1 采集链路：StartGathering → Tick若干次 → 背包增长/技能增长 → 任务计数增长。\n8.2.2 战斗链路：StartBattle → Tick循环 → 掉落入库 → 任务完成触发 → 区域解锁。\n8.2.3 存档链路：保存 → 清空内存 → 读取 → 恢复一致；版本迁移补字段正确。\n\n8.3 DI与可测性（工程约束）\n\n8.3.1 Core服务（Rng/Time/DataStore/Clock）以接口注入，测试时替换为Fake实现。\n8.3.2 UI不直接改Core状态，仅调用用例；Core状态变化通过事件回推UI（避免“UI分叉逻辑”）。\n\n8.4 CI建议（可选，但推荐）\n\n8.4.1 每次提交：构建 → 运行Core单测 → 输出覆盖率（可先不设门槛，后续加阈值）。\n8.4.2 发布：生成可执行版本并带上内容配置文件（Base + DLC可选包）。\n\n九，总结与下一步\n9.1 T2验收标准（DoD：闭环必须跑通）\n\n9.1.1 主游戏闭环：\na.新档进入主界面 → 可采集/制作/战斗并获得成长；\nb.至少2个采集技能可用，且各≥2个采集点；\nc.至少1个制作技能可用，且≥5条配方；\nd.至少1个战斗区域（≥3种怪）+ 1个阶段Boss；\ne.通过“战斗/任务/技能门槛”至少解锁1个新区域；\nf.阶段结算（Boss击败或关键任务完成提示）明确，且可继续推进。\n\n9.1.2 DLC闭环（最小接入 + 联动验证）：\na.地图上可见DLC区域（未启用显示锁定提示，启用后可进入）；\nb.DLC区域至少包含：1个采集点 + 1种怪 + 1条任务链入口；\nc.DLC材料可用于主世界至少1条配方或强化（资源反哺成立）；\nd.DLC完成里程碑给予至少1项全局被动或主世界可用装备（能力反哺成立）。\n\n9.1.3 工程底座：\na.RngService可固定Seed（用于复现掉落/稀有）；\nb.Core具备基础单测覆盖（经验公式、掉落roll、制作材料扣减、战斗胜负判定）；\nc.存档可保存并加载继续，离线收益可正确结算一次。\n\n9.2 实施顺序建议（便于后续拆解）\n\n9.2.1 第一优先级（闭环骨架）：GameState + DataStore + TimeService（离线差值） + EventBus + RngService。\n9.2.2 第二优先级（采集/制作闭环）：SkillManager + ActivitySystem（采集Tick）+ InventoryManager + CraftingManager。\n9.2.3 第三优先级（战斗闭环）：CombatManager + DamageCalculator + LootGenerator + CombatScreen + 1个Boss与掉落表。\n9.2.4 第四优先级（地图推进 + DLC最小接入）：MapManager + RegionUnlocks + DlcManager + DLC Manifest 与联动配方/被动。

