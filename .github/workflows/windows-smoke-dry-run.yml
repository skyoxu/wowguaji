name: Windows Smoke (Dry Run)

# Notes:
# - Runs headless smoke and GdUnit tests only (no export/templates).
# - Smoke markers recognized by scripts: [TEMPLATE_SMOKE_READY] (preferred), [DB] opened (fallback)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: windows-latest
    env:
      GODOT_VERSION: '4.5.1'
      PYTHONIOENCODING: 'utf-8'
      PYTHONUTF8: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Download Godot .NET (Windows)
        shell: pwsh
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          New-Item -ItemType Directory -Force -Path godot | Out-Null
          $zip = "godot/godot.zip"
          $u = "https://github.com/godotengine/godot/releases/download/${env:GODOT_VERSION}-stable/Godot_v${env:GODOT_VERSION}-stable_mono_win64.zip"
          Invoke-WebRequest -UseBasicParsing -Uri $u -OutFile $zip
          Expand-Archive $zip -DestinationPath godot -Force
          $exe = Get-ChildItem godot -Recurse -Filter *win64*.exe | Select-Object -First 1
          if (-not $exe) { throw 'Godot exe not found after download.' }
          "GODOT_BIN=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "GODOT_BIN=$($exe.FullName)"

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\Temp\NuGetScratch
            ~\.nuget\packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}

      - name: Prepare test project link
        shell: pwsh
        run: |
          ./scripts/ci/prepare_gd_tests.ps1 -ProjectPath 'Tests.Godot' -RuntimeDir 'Game.Godot'

      - name: Run GdUnit4 tests
        shell: pwsh
        run: |
          $env:Path = "$HOME\.dotnet;" + $env:Path
          py -3 scripts/python/run_gdunit.py --prewarm --godot-bin "$env:GODOT_BIN" --project Tests.Godot `
            --add tests/Scenes/Smoke `
            --timeout-sec 300 --rd "logs/e2e/${{ github.run_id }}/gdunit-reports/smoke-scenes"

      - name: Headless smoke (no export)
        shell: pwsh
        run: |
          ./scripts/ci/smoke_headless.ps1 -GodotBin "$env:GODOT_BIN" -TimeoutSec 5 -ProjectPath '.'

      - name: Upload smoke logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-logs
          path: |
            logs/ci/**
            logs/e2e/**
          if-no-files-found: ignore
