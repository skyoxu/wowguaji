name: Windows Quality Gate

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: 'Task id(s) for acceptance-check (e.g. 10 / 10.3 / 1-3 / 10,12). Empty = skip.'
        required: false
        default: ''
      strict_adr_status:
        description: 'Fail if any referenced ADR is not Accepted (default: false).'
        required: false
        default: 'false'
      require_perf:
        description: 'Enable perf P95 hard gate (parses [PERF] p95_ms from headless.log) (default: false).'
        required: false
        default: 'false'
      require_task_test_refs:
        description: 'Fail if tasks_back/tasks_gameplay test_refs is empty for the resolved task id (default: false).'
        required: false
        default: 'false'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: windows-latest
    env:
      GODOT_VERSION: '4.5.1'
      PYTHONIOENCODING: 'utf-8'
      PYTHONUTF8: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Logs seed (ensure artifacts paths)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path logs/ci | Out-Null
          New-Item -ItemType Directory -Force -Path logs/e2e | Out-Null
          Set-Content -Path logs/ci/.seed -Value 'seed' -Encoding utf8
          Set-Content -Path logs/e2e/.seed -Value 'seed' -Encoding utf8

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Pin .NET SDK/Runtime and set DOTNET_ROOT
        shell: pwsh
        run: |
          $installer = "$HOME/dotnet-install.ps1"
          Invoke-WebRequest -UseBasicParsing -Uri 'https://dot.net/v1/dotnet-install.ps1' -OutFile $installer
          & powershell -NoProfile -ExecutionPolicy Bypass -File $installer -Version 8.0.401 -InstallDir "$HOME/.dotnet"
          & powershell -NoProfile -ExecutionPolicy Bypass -File $installer -Runtime dotnet -Version 8.0.21 -InstallDir "$HOME/.dotnet"
          "DOTNET_ROOT=$HOME/.dotnet" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "$HOME/.dotnet" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
          dotnet --info

      - name: Download Godot .NET (GitHub Releases)
        shell: pwsh
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          New-Item -ItemType Directory -Force -Path godot | Out-Null
          $zip = "godot/godot.zip"
          $u = "https://github.com/godotengine/godot/releases/download/${env:GODOT_VERSION}-stable/Godot_v${env:GODOT_VERSION}-stable_mono_win64.zip"
          Invoke-WebRequest -UseBasicParsing -Uri $u -OutFile $zip
          Expand-Archive $zip -DestinationPath godot -Force
          $exe = Get-ChildItem godot -Recurse -Filter *win64*.exe | Select-Object -First 1
          if (-not $exe) { throw 'Godot exe not found after download.' }
          "GODOT_BIN=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "GODOT_BIN=$($exe.FullName)"

      - name: Setup Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Forbid mirror path refs (hard)
        shell: pwsh
        run: |
          py -3 scripts/python/forbid_mirror_path_refs.py --root .

      - name: Ensure GdUnit4 plugin
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $date = Get-Date -Format 'yyyy-MM-dd'
          $ciDir = "logs/ci/$date"
          New-Item -ItemType Directory -Force -Path $ciDir | Out-Null
          $diag = Join-Path $ciDir 'ensure-gdunit4-diag.txt'
          "CWD=$(Get-Location)" | Out-File -FilePath $diag -Encoding utf8
          $pyv = (& py -3 -V 2>&1)
          "PY3=$pyv" | Out-File -FilePath $diag -Append -Encoding utf8
          $pyinfo = (& py -3 -c "import sys,os; print(sys.executable); print(os.getcwd())" 2>&1)
          "PYINFO=$pyinfo" | Out-File -FilePath $diag -Append -Encoding utf8
          if (-not (Test-Path 'scripts/python/ensure_gdunit_plugin.py')) {
            'MISSING scripts/python/ensure_gdunit_plugin.py' | Out-File -FilePath $diag -Append -Encoding utf8
            Get-ChildItem -Recurse scripts/python -ErrorAction SilentlyContinue | Select-Object -First 100 FullName | Out-File -FilePath $diag -Append -Encoding utf8
            Write-Error 'ensure_gdunit_plugin.py missing'; exit 1
          }
          & py -3 scripts/python/ensure_gdunit_plugin.py --project Tests.Godot --version v6.0.0 *>&1 | Tee-Object -FilePath (Join-Path $ciDir 'ensure-gdunit4-stdout.txt') | Out-Null
          if (Test-Path 'Tests.Godot/addons/gdUnit4/bin/GdUnitCmdTool.gd') {
            'GDUNIT_PLUGIN_READY' | Out-File -FilePath $diag -Append -Encoding utf8
          }
          else {
            'GDUNIT_PLUGIN_MISSING after ensure' | Out-File -FilePath $diag -Append -Encoding utf8
            'Tree addons/gdUnit4:' | Out-File -FilePath $diag -Append -Encoding utf8
            Get-ChildItem -Recurse 'Tests.Godot/addons/gdUnit4' -ErrorAction SilentlyContinue | Select-Object -First 200 FullName | Out-File -FilePath $diag -Append -Encoding utf8
            'Tree Tests.Godot (first 200):' | Out-File -FilePath $diag -Append -Encoding utf8
            Get-ChildItem -Recurse 'Tests.Godot' -ErrorAction SilentlyContinue | Select-Object -First 200 FullName, Length | Out-File -FilePath $diag -Append -Encoding utf8
            Write-Error 'GDUNIT_PLUGIN_MISSING after ensure'; exit 1
          }

      - name: Install Export Templates (GitHub Releases)
        shell: pwsh
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $tpz = "godot/export_templates.tpz"
          $u = "https://github.com/godotengine/godot/releases/download/${env:GODOT_VERSION}-stable/Godot_v${env:GODOT_VERSION}-stable_export_templates.tpz"
          Invoke-WebRequest -UseBasicParsing -Uri $u -OutFile $tpz
          $temp = "godot/templates_unpacked"
          Expand-Archive $tpz -DestinationPath $temp -Force
          $src = Join-Path $temp 'templates'
          if (Test-Path $src) { $copyFrom = $src } else { $copyFrom = $temp }
          $verMono = "${env:GODOT_VERSION}.stable.mono"
          $ver = "${env:GODOT_VERSION}.stable"
          $dsts = @(
            (Join-Path $env:APPDATA ("Godot/templates/$verMono")),
            (Join-Path $env:APPDATA ("Godot/templates/$ver")),
            (Join-Path $env:APPDATA ("Godot/export_templates/$verMono")),
            (Join-Path $env:APPDATA ("Godot/export_templates/$ver"))
          )
          New-Item -ItemType Directory -Force -Path $dsts | Out-Null
          foreach ($d in $dsts) { Copy-Item -Recurse -Force "$copyFrom/*" $d }
          Write-Host ("Templates installed: " + ($dsts -join ', '))

      - name: Prewarm & Build Solutions
        shell: pwsh
        run: |
          $env:Path = "$HOME\.dotnet;" + $env:Path
          $env:GODOT_DOTNET_CLI = (Get-Command dotnet).Path
          try { & "$env:GODOT_BIN" --headless --path . --quit } catch { Write-Warning $_ }
          dotnet restore GodotGame.csproj
          dotnet build GodotGame.csproj -c Release -v minimal

      - name: CI pipeline (Python)
        shell: pwsh
        run: |
          py -3 scripts/python/ci_pipeline.py all --solution Game.sln --configuration Debug --godot-bin "$env:GODOT_BIN" --build-solutions

      - name: Resolve Task IDs for acceptance-check
        shell: pwsh
        run: |
          $tasksJson = ".taskmaster/tasks/tasks.json"
          if (-not (Test-Path $tasksJson)) {
            Write-Host "SC_ACCEPTANCE skipped: missing $tasksJson"
            "SC_TASK_IDS=" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            exit 0
          }

          $spec = ""
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $spec = "${{ inputs.task_id }}"
          } elseif ("${{ github.event_name }}" -eq "pull_request") {
            $spec = "${{ github.event.pull_request.title }}"
          } else {
            # push: no explicit spec, try fallback
            $spec = ""
          }

          if ($spec -match 'Task\\s*\\[([^\\]]+)\\]') { $spec = $Matches[1] }
          $spec = ($spec -replace '\\s', '').Trim()

          if ([string]::IsNullOrWhiteSpace($spec)) {
            if ("${{ github.event_name }}" -eq "workflow_dispatch") {
              Write-Host "SC_ACCEPTANCE skipped: workflow_dispatch input task_id is empty"
              "SC_TASK_IDS=" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
              exit 0
            }

            try {
              $fallback = (& py -3 -c "import json; from pathlib import Path; p=Path('.taskmaster/tasks/tasks.json'); d=json.loads(p.read_text(encoding='utf-8')); tasks=d.get('master',{}).get('tasks',[]); t=next((x for x in tasks if str(x.get('status','')).lower()=='in-progress'), None); print((t or {}).get('id',''))").Trim()
            } catch {
              $fallback = ""
            }

            if ([string]::IsNullOrWhiteSpace($fallback)) {
              Write-Host "SC_ACCEPTANCE skipped: no task id resolved (provide workflow_dispatch input task_id or name PR like: Task [10]:<title>)"
              "SC_TASK_IDS=" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
              exit 0
            }

            "SC_TASK_IDS=$fallback" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            Write-Host "SC_TASK_IDS=$fallback (fallback)"
            exit 0
          }

          $ids = New-Object System.Collections.Generic.List[string]
          foreach ($part in $spec.Split(',')) {
            if ($part -match '^\\d+(\\.\\d+)?$') {
              $ids.Add($part)
              continue
            }
            if ($part -match '^(\\d+)-(\\d+)$') {
              $a = [int]$Matches[1]
              $b = [int]$Matches[2]
              if ($b -lt $a) { $t = $a; $a = $b; $b = $t }
              for ($i = $a; $i -le $b; $i++) { $ids.Add($i.ToString()) }
              continue
            }
          }

          $uniq = $ids | Select-Object -Unique
          if (-not $uniq -or $uniq.Count -eq 0) {
            Write-Host "SC_ACCEPTANCE skipped: invalid task id spec '$spec'"
            "SC_TASK_IDS=" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            exit 0
          }

          "SC_TASK_IDS=$($uniq -join ',')" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "SC_TASK_IDS=$($uniq -join ',')"

      - name: Acceptance check (sc)
        if: ${{ env.SC_TASK_IDS != '' }}
        shell: pwsh
        run: |
          $date = (& py -3 -c "import datetime as dt; print(dt.date.today().strftime('%Y-%m-%d'))").Trim()
          $strict = "${{ github.event_name == 'workflow_dispatch' && inputs.strict_adr_status || 'false' }}"
          $reqPerf = "${{ github.event_name == 'workflow_dispatch' && inputs.require_perf || 'false' }}"
          $reqRefs = "${{ github.event_name == 'workflow_dispatch' && inputs.require_task_test_refs || 'false' }}"

          foreach ($id in $env:SC_TASK_IDS.Split(',')) {
            $only = @('adr','overlay','contracts','arch','build','security','quality','rules')
            if ((Test-Path ".taskmaster/tasks/tasks_back.json") -and (Test-Path ".taskmaster/tasks/tasks_gameplay.json")) {
              $only += 'links'
            }
            if ($reqPerf -eq "true") { $only += 'perf' }
            $onlyArg = $only -join ','

            $args = @("py", "-3", "scripts/sc/acceptance_check.py", "--task-id", $id, "--only", $onlyArg)
            if ($strict -eq "true") { $args += "--strict-adr-status" }
            if ($reqPerf -eq "true") { $args += "--require-perf" }
            if ($reqRefs -eq "true") { $args += "--require-task-test-refs" }
            & $args[0] $args[1..($args.Length-1)]
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

            # If multiple task ids were provided, preserve each report directory.
            $src = "logs/ci/$date/sc-acceptance-check"
            $safeId = $id.Replace('.', '_')
            $dst = "logs/ci/$date/sc-acceptance-check-task-$safeId"
            if (Test-Path $src) {
              if (Test-Path $dst) { Remove-Item -Recurse -Force $dst }
              Move-Item $src $dst -Force
            }
          }

      - name: Upload CI logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: logs/ci/**
          if-no-files-found: ignore

      - name: GdUnit4 tests (Python, soft gate)
        shell: pwsh
        continue-on-error: true
        run: |
          py -3 scripts/python/run_gdunit.py --prewarm --godot-bin "$env:GODOT_BIN" --project Tests.Godot `
            --add tests/Adapters `
            --add tests/Security/Hard `
            --add tests/Integration `
            --add tests/UI `
            --timeout-sec 480 --rd "logs/e2e/${{ github.run_id }}/gdunit-reports/quality"

      - name: GdUnit4 a11y tests (Python, soft gate)
        shell: pwsh
        continue-on-error: true
        run: |
          py -3 scripts/python/run_gdunit.py --prewarm --godot-bin "$env:GODOT_BIN" --project Tests.Godot --add tests/UI/A11y --timeout-sec 300 --rd "logs/e2e/${{ github.run_id }}/gdunit-reports/a11y"

      - name: A11y static check (soft)
        shell: pwsh
        continue-on-error: true
        run: |
          py -3 scripts/python/check_a11y.py --out "logs/ci/${{ github.run_id }}/a11y/summary.json"

      - name: Upload self-check logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: selfcheck-logs
          path: logs/e2e/**
          if-no-files-found: ignore

      - name: Upload GdUnit reports (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gdunit-reports
          path: logs/e2e/**/gdunit-reports/**
          if-no-files-found: ignore

      - name: Schema dump (soft)
        shell: pwsh
        continue-on-error: true
        run: |
          $date = Get-Date -Format 'yyyy-MM-dd'
          $out = "logs/ci/${{ github.run_id }}/schema-dump.json"
          py -3 scripts/python/db_schema_dump.py --glob "$env:APPDATA\Godot\app_userdata\wowguaji\*.db" --out "$out"
          Write-Host "SCHEMA_DUMP_OUT=$out"
