name: Windows Quality Gate

# Notes:
# - Smoke markers recognized by scripts:
#   [TEMPLATE_SMOKE_READY] (preferred), [DB] opened (fallback)
# - Export templates are installed before export; headless smoke runs regardless.

on:
  workflow_dispatch:
    inputs:
      with_export:
        description: "Include export + EXE smoke"
        type: choice
        options: [ 'false', 'true' ]
        default: 'false'
      include_demo:
        description: "Enable demo screens/tests (TEMPLATE_DEMO=1)"
        type: choice
        options: [ 'false', 'true' ]
        default: 'false'
      perf_p95_ms:
        description: "Perf budget P95 (ms), 0 to skip"
        type: number
        default: 0

jobs:
  quality:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Download Godot .NET (mono) with fallback
        shell: pwsh
        run: |
          $Version = '4.5.1'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          New-Item -ItemType Directory -Force -Path godot | Out-Null
          $zip = "godot/godot.zip"
          $urls = @(
            "https://github.com/godotengine/godot/releases/download/${Version}-stable/Godot_v${Version}-stable_mono_win64.zip",
            "https://downloads.tuxfamily.org/godotengine/${Version}/mono/Godot_v${Version}-stable_mono_win64.zip"
          )
          $ok = $false
          for ($i=1; $i -le 3 -and -not $ok; $i++) {
            foreach ($u in $urls) {
              Write-Host "Attempt #${i}: downloading $u"
              try { Invoke-WebRequest -UseBasicParsing -Uri $u -OutFile $zip; $ok = $true; break } catch { Write-Warning $_; Start-Sleep -Seconds (3*$i) }
            }
          }
          if (-not $ok) { throw 'Failed to download Godot after retries.' }
          Expand-Archive $zip -DestinationPath godot -Force
          $exe = Get-ChildItem godot -Recurse -Filter *win64*.exe | Select-Object -First 1
          if (-not $exe) { throw 'Godot exe not found after download.' }
          "GODOT_BIN=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "GODOT_BIN=$($exe.FullName)"

      - name: Prewarm Godot C# build (first compile)
        shell: pwsh
        run: |
          $env:Path = "$HOME\.dotnet;" + $env:Path
          & "$env:GODOT_BIN" --headless --path . --quit

      - name: Build C# solutions
        shell: pwsh
        run: |
          $env:Path = "$HOME\.dotnet;" + $env:Path
          & "$env:GODOT_BIN" --headless --path . --build-solutions --quit

      - name: Install Export Templates (with fallback)
        if: ${{ inputs.with_export == 'true' }}
        shell: pwsh
        run: |
          $Version = '4.5.1'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $tpz = "godot/export_templates.tpz"
          $urls = @(
            "https://github.com/godotengine/godot/releases/download/${Version}-stable/Godot_v${Version}-stable_export_templates.tpz",
            "https://downloads.tuxfamily.org/godotengine/${Version}/Godot_v${Version}-stable_export_templates.tpz"
          )
          $ok = $false
          for ($i=1; $i -le 3 -and -not $ok; $i++) {
            foreach ($u in $urls) {
              Write-Host "Attempt #${i}: downloading templates $u"
              try { Invoke-WebRequest -UseBasicParsing -Uri $u -OutFile $tpz; $ok = $true; break } catch { Write-Warning $_; Start-Sleep -Seconds (3*$i) }
            }
          }
          if (-not $ok) { throw 'Failed to download export templates after retries.' }
          $temp = "godot/templates_unpacked"
          Expand-Archive $tpz -DestinationPath $temp -Force
          $ver = "$Version.stable.mono"
          $dst = Join-Path $env:APPDATA ("Godot/templates/$ver")
          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          Copy-Item -Recurse -Force "$temp/*" $dst
          Write-Host "Export templates installed to $dst"

      - name: Dotnet tests
        shell: pwsh
        run: ./scripts/ci/run_dotnet_tests.ps1 -Solution 'Game.sln'

      - name: GdUnit4 tests
        shell: pwsh
        env:
          TEMPLATE_DEMO: ${{ inputs.include_demo == 'true' && '1' || '' }}
        run: |
          $env:Path = "$HOME\.dotnet;" + $env:Path
          ./scripts/ci/run_gdunit_tests.ps1 -GodotBin "$env:GODOT_BIN"

      - name: Headless smoke
        shell: pwsh
        run: ./scripts/ci/smoke_headless.ps1 -GodotBin "$env:GODOT_BIN" -TimeoutSec 5

      - name: Export Windows EXE
        if: ${{ inputs.with_export == 'true' }}
        shell: pwsh
        run: ./scripts/ci/export_windows.ps1 -GodotBin "$env:GODOT_BIN" -Output build\Game.exe

      - name: Smoke EXE
        if: ${{ inputs.with_export == 'true' }}
        shell: pwsh
        run: ./scripts/ci/smoke_exe.ps1 -ExePath build\Game.exe -TimeoutSec 5

      - name: Perf budget gate
        if: ${{ inputs.perf_p95_ms != 0 }}
        shell: pwsh
        run: ./scripts/ci/check_perf_budget.ps1 -MaxP95Ms ${{ inputs.perf_p95_ms }}
