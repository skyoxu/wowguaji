name: Windows CI (Godot + GdUnit4)

# Notes:
# - Smoke markers recognized by scripts:
#   [TEMPLATE_SMOKE_READY] (preferred), [DB] opened (fallback)
# - Export templates are installed before export (see Install Export Templates step).

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-export:
    runs-on: windows-latest
    env:
      GODOT_VERSION: 4.5.1
      GODOT_BIN: ${{ github.workspace }}\godot\Godot_v4.5.1-stable_mono_win64.exe
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Download Godot .NET (Windows) with fallback
        shell: pwsh
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          New-Item -ItemType Directory -Force -Path godot | Out-Null
          $zip = "godot/godot.zip"
          $urls = @(
            "https://github.com/godotengine/godot/releases/download/${env:GODOT_VERSION}-stable/Godot_v${env:GODOT_VERSION}-stable_mono_win64.zip",
            "https://downloads.tuxfamily.org/godotengine/${env:GODOT_VERSION}/mono/Godot_v${env:GODOT_VERSION}-stable_mono_win64.zip"
          )
          $ok = $false
          for ($i=1; $i -le 3 -and -not $ok; $i++) {
            foreach ($u in $urls) {
              Write-Host "Attempt #${i}: downloading $u"
              try { Invoke-WebRequest -UseBasicParsing -Uri $u -OutFile $zip; $ok = $true; break } catch { Write-Warning $_; Start-Sleep -Seconds (3*$i) }
            }
          }
          if (-not $ok) { throw 'Failed to download Godot after retries.' }
          \ \ \ \ \ \ \ \ \ \ Expand-Archive\ \ -DestinationPath\ godot\ -Force`n\ \ \ \ \ \ \ \ \ \ \ =\ Get-ChildItem\ godot\ -Recurse\ -Filter\ \*win64\*\.exe\ \|\ Select-Object\ -First\ 1`n\ \ \ \ \ \ \ \ \ \ if\ \(-not\ \)\ \{\ throw\ 'Godot\ exe\ not\ found\ after\ download\.'\ }`n\ \ \ \ \ \ \ \ \ \ "GODOT_BIN="\ \|\ Out-File\ -FilePath\ \ -Append\ -Encoding\ utf8`n\ \ \ \ \ \ \ \ \ \ Write-Host\ "GODOT_BIN="

      - name: Install Export Templates (with fallback)
        shell: pwsh
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $tpz = "godot/export_templates.tpz"
          $urls = @(
            "https://github.com/godotengine/godot/releases/download/${env:GODOT_VERSION}-stable/Godot_v${env:GODOT_VERSION}-stable_export_templates.tpz",
            "https://downloads.tuxfamily.org/godotengine/${env:GODOT_VERSION}/Godot_v${env:GODOT_VERSION}-stable_export_templates.tpz"
          )
          $ok = $false
          for ($i=1; $i -le 3 -and -not $ok; $i++) {
            foreach ($u in $urls) {
              Write-Host "Attempt #${i}: downloading templates $u"
              try { Invoke-WebRequest -UseBasicParsing -Uri $u -OutFile $tpz; $ok = $true; break } catch { Write-Warning $_; Start-Sleep -Seconds (3*$i) }
            }
          }
          if (-not $ok) { throw 'Failed to download export templates after retries.' }
          $temp = "godot/templates_unpacked"
          Expand-Archive $tpz -DestinationPath $temp -Force
          $ver = "${env:GODOT_VERSION}.stable.mono"
          $dst = Join-Path $env:APPDATA ("Godot/templates/$ver")
          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          Copy-Item -Recurse -Force "$temp/*" $dst
          Write-Host "Export templates installed to $dst"

      - name: Prewarm & Build Solutions
        continue-on-error: true
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $env:Path = "$HOME\.dotnet;" + $env:Path
          $env:GODOT_DOTNET_CLI = (Get-Command dotnet).Path
          dotnet --info
          dotnet restore GodotGame.csproj
          dotnet build GodotGame.csproj -c Release -v minimal
          try { & "$env:GODOT_BIN" --headless --path . --build-solutions --verbose --quit } catch { Write-Warning $_ }

      - name: Cache .dotnet tools
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\Temp`nuGetScratch
            ~\.nuget\packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}

      - name: Run GdUnit4 tests
        continue-on-error: true
        shell: pwsh
        run: |
          $env:Path = "$HOME\.dotnet;" + $env:Path
          .\scripts\ci\run_gdunit_tests.ps1 -GodotBin "$env:GODOT_BIN"

      - name: Export Windows build
        if: always()
        shell: pwsh
        run: |
          .\scripts\ci\export_windows.ps1 -GodotBin "$env:GODOT_BIN" -Preset "Windows Desktop" -Output build\Game.exe

      - name: Print export log tail (always)
        if: always()
        shell: pwsh
        run: |
          $log = Get-ChildItem -Recurse -Filter godot_export.log -Path logs -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($log) {
            Write-Host "Export log: $($log.FullName)"
            Get-Content $log.FullName -Tail 200
          } else {
            Write-Warning 'No godot_export.log found under logs/**'
          }

      - name: Upload export logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: export-logs
          path: logs/ci/**/export/**

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            build\Game.exe
            logs\ci\**\*


